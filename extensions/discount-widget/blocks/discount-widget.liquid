{% schema %}
{
  "name": "Discount Widget",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Flash Deal"
    },
    {
      "type": "text",
      "id": "subtext",
      "label": "Subtext",
      "default": "Enter your code to unlock savings"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color",
      "default": "#2c6ecb"
    }
  ]
}
{% endschema %}

<div class="sw-discount-container" style="--accent-color: {{ block.settings.accent_color }};">
  <div class="sw-discount-card">
    <div class="sw-discount-header">
      <div class="sw-discount-titles">
        <h3>{{ block.settings.heading }}</h3>
        <p>{{ block.settings.subtext }}</p>
      </div>
    </div>

    <div class="sw-discount-input-group">
      <div class="sw-input-wrapper">
        <input
          type="text"
          name="discount_code"
          id="discount_code"
          placeholder="e.g. SAVE20"
          autocomplete="off"
        >
      </div>
      <button type="button" id="sw_apply_button" class="sw-apply-btn">
        <span class="btn-text">Apply</span>
        <div class="btn-loader"></div>
      </button>
      <button type="button" id="sw_remove_button" class="sw-remove-btn" style="display: none;">
        <span>Remove</span>
      </button>
    </div>

    <div id="sw_message_container" class="sw-message-container">
      <p id="discount_message" class="sw-discount-message"></p>
    </div>
  </div>
</div>

<style>
  :root {
    --sw-bg: #ffffff;
    --sw-secondary-bg: #f8fafc;
    --sw-border: #e2e8f0;
    --sw-text: #1e293b;
    --sw-text-muted: #64748b;
    --sw-success: #10b981;
    --sw-error: #ef4444;
    --sw-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --sw-radius: 12px;
    --sw-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sw-discount-container {
    padding: 24px 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }

  .sw-discount-card {
    background: var(--sw-bg);
    border: 1px solid var(--sw-border);
    border-radius: var(--sw-radius);
    padding: 20px;
    box-shadow: var(--sw-shadow);
    max-width: 400px;
    margin: 0 auto;
    transition: var(--sw-transition);
  }

  .sw-discount-card:hover {
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    transform: translateY(-2px);
  }

  .sw-discount-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .sw-discount-titles h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--sw-text);
  }

  .sw-discount-titles p {
    margin: 4px 0 0;
    font-size: 13px;
    color: var(--sw-text-muted);
  }

  .sw-discount-input-group {
    display: flex;
    gap: 10px;
  }

  .sw-input-wrapper {
    position: relative;
    flex-grow: 1;
  }

  #discount_code {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--sw-border);
    border-radius: 8px;
    font-size: 15px;
    outline: none;
    transition: var(--sw-transition);
    box-sizing: border-box;
  }

  #discount_code:focus {
    border-color: var(--accent-color);
  }

  .sw-apply-btn {
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0 24px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: var(--sw-transition);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 100px;
  }

  .sw-apply-btn:hover {
    filter: brightness(1.1);
    transform: scale(1.02);
  }

  .sw-apply-btn:active {
    transform: scale(0.98);
  }

  .sw-apply-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .sw-message-container {
    height: 0;
    overflow: hidden;
    transition: var(--sw-transition);
  }

  .sw-message-container.visible {
    height: auto;
    margin-top: 16px;
  }

  .sw-discount-message {
    margin: 0;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sw-discount-message.success {
    background: color-mix(in srgb, var(--sw-success), transparent 90%);
    color: #065f46;
    border: 1px solid color-mix(in srgb, var(--sw-success), transparent 80%);
  }

  .sw-discount-message.error {
    background: color-mix(in srgb, var(--sw-error), transparent 90%);
    color: #991b1b;
    border: 1px solid color-mix(in srgb, var(--sw-error), transparent 80%);
  }

  .sw-remove-btn {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 0 16px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: var(--sw-transition);
  }

  .sw-remove-btn:hover {
    background: #fecaca;
  }

  /* Loader Animation */
  .btn-loader {
    display: none;
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: sw-spin 0.8s linear infinite;
    position: absolute;
  }

  .loading .btn-text {
    visibility: hidden;
  }

  .loading .btn-loader {
    display: block;
  }

  @keyframes sw-spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  (function () {
    const applyBtn = document.querySelector('#sw_apply_button');
    const removeBtn = document.querySelector('#sw_remove_button');
    const input = document.querySelector('#discount_code');
    const messageContainer = document.querySelector('#sw_message_container');
    const displayMsg = document.querySelector('#discount_message');

    if (!applyBtn) return;

    applyBtn.addEventListener('click', async function () {
      // Try to get cart total, or product price if on product page
      let cartTotal = {{ cart.total_price | default: 0 }};
      {% if product %}
        if (cartTotal === 0) cartTotal = {{ product.price | default: 0 }};
      {% endif %}

      const discountCode = input.value.trim();

      if (!discountCode) {
        showMessage('Please enter a code', 'error');
        return;
      }

      setLoading(true);

      try {
        const response = await fetch('/apps/discount-proxy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ code: discountCode, cartTotal: cartTotal }),
        });

        const data = await response.json();
        
        if (data.valid) {
          fetch(`/discount/${data.discountCode}`, { mode: 'no-cors' });

          if (data.type === 'gift_card') {
            await fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                attributes: {
                  'Applied Discount Code': data.discountCode,
                  'Savings Amount': data.appliedAmount
                }
              })
            });
            
            showMessage(data.message, 'success');
          } else {
            showMessage(`Discount "${discountCode}" applied!`, 'success');
          }

          // 2. Update UI instantly without refresh using Atomic Scanner
          updateStorefrontPrices(data.appliedAmount || 0);
          setAppliedState(true, data.discountCode);
          setLoading(false);

        } else {
          setLoading(false);
          showMessage(data.message || 'Invalid code', 'error');
        }
      } catch (error) {
        setLoading(false);
        showMessage('Could not verify code. Try again.', 'error');
        console.error('Error:', error);
      }
    });

    removeBtn.addEventListener('click', async function() {
        setLoading(true);
        try {
            fetch('/discount/CLEAR', { mode: 'no-cors' });
            
            await fetch('/cart/update.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    attributes: {
                        'Applied Discount Code': null,
                        'Savings Amount': null
                    }
                })
            });

            updateStorefrontPrices(0, true);
            setAppliedState(false);
            input.value = "";
            messageContainer.classList.remove('visible');
            setLoading(false);
        } catch (e) {
            setLoading(false);
            console.error(e);
        }
    });

    let originalPrices = new Map();

    function updateStorefrontPrices(savings, reset = false) {
        console.log(`[Atomic Price Update] Starting. Savings: ${savings}, Reset: ${reset}`);
        
        const priceRegex = /([a-zA-Z.$£€₹]{1,3})\s?([\d,]+\.\d{2})/;
        
        function processNode(node) {
            const skipTags = ['SCRIPT', 'STYLE', 'TEXTAREA', 'NOSCRIPT', 'TEMPLATE'];
            if (node.parentElement && skipTags.includes(node.parentElement.tagName)) return;

            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent;
                const match = text.match(priceRegex);
                
                if (match) {
                    const symbol = match[1]; 
                    const priceText = match[2];
                    const currentPrice = parseFloat(priceText.replace(/,/g, ''));
                    
                    if (currentPrice === 0 && !reset) return;

                    if (reset) {
                        if (originalPrices.has(node)) node.textContent = originalPrices.get(node);
                        return;
                    }

                    if (!originalPrices.has(node)) originalPrices.set(node, node.textContent);
                    
                    const newPrice = Math.max(0, currentPrice - savings);
                    const formattedPrice = newPrice.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    const newText = text.replace(match[0], symbol + (symbol.length > 2 ? ' ' : '') + formattedPrice);
                    node.textContent = newText;
                }
            } else {
                if (node.id === 'sw_discount_container' || (node.classList && node.classList.contains('sw-discount-container'))) return;
                node.childNodes.forEach(processNode);
            }
        }

        processNode(document.body);
    }

    document.addEventListener('click', function(e) {
        const checkoutBtn = e.target.closest('button[name="checkout"], a[href*="/checkout"], .checkout-button');
        const activeCode = input.getAttribute('data-applied-code');
        
        if (checkoutBtn && activeCode) {
            const currentHref = checkoutBtn.form ? checkoutBtn.form.action : checkoutBtn.href;
            const separator = currentHref && currentHref.includes('?') ? '&' : '?';
            
            if (checkoutBtn.form) {
                const inputHidden = document.createElement('input');
                inputHidden.type = 'hidden';
                inputHidden.name = 'discount';
                inputHidden.value = activeCode;
                checkoutBtn.form.appendChild(inputHidden);
            } else if (checkoutBtn.href) {
                checkoutBtn.href = `${currentHref}${separator}discount=${activeCode}`;
            }
        }
    }, true);

    function setAppliedState(isApplied, code = "") {
        if (isApplied) {
            input.disabled = true;
            input.setAttribute('data-applied-code', code);
            applyBtn.style.display = 'none';
            removeBtn.style.display = 'block';
        } else {
            input.disabled = false;
            input.removeAttribute('data-applied-code');
            applyBtn.style.display = 'flex';
            removeBtn.style.display = 'none';
        }
    }

    function showMessage(msg, type) {
      displayMsg.textContent = msg;
      displayMsg.className = 'sw-discount-message ' + type;
      messageContainer.classList.add('visible');
    }

    function setLoading(isLoading) {
      if (isLoading) {
        if (applyBtn.classList.contains('loading')) return;
        applyBtn.classList.add('loading');
        applyBtn.disabled = true;
        removeBtn.disabled = true;
      } else {
        applyBtn.classList.remove('loading');
        applyBtn.disabled = false;
        removeBtn.disabled = false;
      }
    }
  })();
</script>
